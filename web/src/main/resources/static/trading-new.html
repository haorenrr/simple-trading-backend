<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/html" xmlns:background="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/vue.global.js"></script>
    <script src="/js/axios.min.js"></script>
    <script src="/js/echarts.min.js"></script>
    <script src = "/js/bootstrap.bundle.min.js"></script>

    <!--icons使用本地包不行，使用CDN可以，会额外请求字体文件，回头研究一下！
        答案：idea内置的built-in server（静态文件预览器）不提供 xx.woff格式的文件请求，因此会失败。启动正常的webserver等则无此问题，
        为了使用idea内置浏览器调试，先引用cdn模式
    -->
    <link rel="stylesheet" href="/font/bs-icons/bootstrap-icons.css">
    <!--        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">-->
    <link rel="stylesheet" href="/font/inter/inter.css">

    <style>
        /**
        如果在nav中使用 .fixed-top属性，这个nav将脱离文档流，后果就是会覆盖后续元素，解决办法就是：
        1） 把后续元素（<body>)整体后移，如这段css的定义
        2） 或者是，把fixed-top，替换为sticky-top
         */
        body{
            /*padding-top: 4.5rem;*/
        }
        /* 1. 锁定 navbar 本体高度 */
        .navbar-48 {
            height: 48px;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* 2. container 垂直拉满 */
        .navbar-48 > .container-fluid {
            height: 100%;
        }

        /* 3. brand 精确对齐 */
        .navbar-48 .navbar-brand {
            font-size: 1rem;
            line-height: 1;
            padding: 0;
        }

        /* 4. nav-link 不再撑高 */
        .navbar-48 .nav-link {
            padding-top: 0;
            padding-bottom: 0;
            line-height: 48px;
        }

        /* 5. 最关键：压缩 toggler */
        .navbar-48 .navbar-toggler {
            padding: 0 0.5rem;
            height: 48px;
            line-height: 48px;
            border: none;
        }

        /* table header won't be bold*/
        .table-head-lgihter thead th{
            font-weight: lighter;
        }

        /* trading borad, setting its height mainly!  */
        .custom-main-board{
            height: 50vh;
            overflow: hidden;
        }

        /*优化UI样式*/
        /*添加新字体，Inter*/
        :root { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) {
            :root { font-family: 'Inter var', sans-serif; }
        }
        body {
            background-color: #f8fafc; /* 使用更高级的蓝灰色调背景 */
            font-family: 'Inter', -apple-system, sans-serif; /* 建议引入 Inter 字体 */
        }
        .card {
            border: none !important; /* 去掉生硬的边框 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* 柔和的阴影 */
            border-radius: 12px; /* 更圆润的角 */
        }
        /* 买入按钮：改为更深邃的翡翠绿 */
        .btn-success {
            background-color: #10b981 !important;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        /* 卖出按钮：改为偏粉红的珊瑚色 */
        .btn-danger {
            background-color: #ef4444 !important;
            border: none;
        }

        .btn:hover {
            transform: translateY(-1px); /* 增加轻微的浮动感 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* 1. 首先移除 Bootstrap 默认的蓝色聚焦光圈，避免冲突 */
        .btn:focus,
        .btn:active:focus {
            box-shadow: none !important;
            outline: none !important;
        }

        /* 2. BUY 按钮被选中 (Focus) 时 */
        .btn-success:focus-visible, /* 针对键盘操作 */
        .btn-success:focus {        /* 兼容点击后保持聚焦 */
            background-color: #047857 !important; /* 颜色变深 (Deep Emerald) */
            transform: translateY(-2px); /* 稍微上浮，比 hover 更明显 */
            /* 核心技巧：双层阴影
               第1层(2px): 白色，把按钮和光圈隔开，产生切割感
               第2层(5px): 绿色半透明，产生发光效果
            */
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 5px rgba(16, 185, 129, 0.6) !important;
            z-index: 5; /* 确保光圈不被旁边元素遮挡 */
        }

        /* 3. SELL 按钮被选中 (Focus) 时 */
        .btn-danger:focus-visible,
        .btn-danger:focus {
            background-color: #b91c1c !important; /* 颜色变深 (Deep Red) */
            transform: translateY(-2px);
            /* 双层阴影：白色隔断 + 红色发光 */
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 5px rgba(239, 68, 68, 0.6) !important;
            z-index: 5;
        }

        .table {
            --bs-table-bg: transparent;
            margin-bottom: 0;
        }

        .table th {
            text-transform: uppercase; /* 小标题全大写更显专业 */
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #94a3b8; /* 灰蓝色 */
            background-color: #fbfcfd;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 700;
        }

        .table td {
            vertical-align: middle;
            font-size: 0.875rem;
            font-variant-numeric: tabular-nums; /* 确保价格位数对齐，不会晃动 */
            font-weight: 500;
        }
        /* 去掉表格生硬的边框，只保留水平分割线 */
        .table td, .table th {
            border-bottom: 1px solid #f1f5f9 !important; /* 使用浅灰色线 */
            border-top: none !important;
            padding: 12px 16px !important;
        }
        /* 移除交易记录背景的生硬颜色，改用极淡的背景 */
        .table-success, .table-success td {
            --flash-color: rgba(16, 185, 129, 0.4); /* 深绿， 这是个变量，子类中引用 */
            background-color: rgba(16, 185, 129, 0.06);
            /*color: #059669; 字体颜色*/
        }
        .table-danger, .table-danger td {
            --flash-color: rgba(244, 63, 94, 0.4); /* 深红，这是个变量，子类中引用 */
            background-color: rgba(244, 63, 94, 0.06) ;
            /*color: #e11d48;  字体颜色*/
        }

        /* 彻底去掉表格的斑马纹干扰，只用颜色区分 */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02) ; /* 极其轻微的悬浮感 */
            cursor: pointer; /* 新增：鼠标悬停时显示手型指针 */
        }

        #liveStatus {
            background: rgba(16, 185, 129, 0.1) !important;
            color: #10b981 !important;
            border: 1px solid rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(4px); /* 背景模糊 */
            padding: 4px 10px;
            border-radius: 20px;
        }

        /* 定义动画：从高亮色淡出到透明 */
        @keyframes row-flash {
            0% { background-color: var(--flash-color); } /* 初始：较明显的蓝色 */
            /*100% { background-color: transparent; }   */        /* 结束：透明 */
        }
        /* 动画类 */
        .row-animate-flash {
            animation: row-flash 2s ease-out forwards !important; /* 持续2秒，平滑结束 */
        }
        /* 核心方案：当 tr 闪烁时，强制让它下面的所有 td 背景透明 */
        .row-animate-flash td {
            background-color: transparent !important;
            transition: background-color 0.5s;
        }

        /**
        定义table样式，主要是固定高度
         */
        /* 针对 table 的上级div包装容器 */
        .table-container {
            height: 40vh; /* 或者使用 vh，如 40vh */
            overflow-y: auto; /* 纵向超出时显示滚动条 */
            position: relative;
        }

        /* 保持表头固定（极其重要！） */
        .table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #fbfcfd; /* 必须设置背景色，否则滚动时内容会重叠 */
        }

        /* 自定义滚动条样式，让它更细更现代 */
        .table-container::-webkit-scrollbar {
            width: 6px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #e2e8f0;
            border-radius: 10px;
        }
        /* 新增：订单详情浮框的样式 */
        .order-detail-key {
            font-weight: 600;
            color: #64748b;
        }

        /* --- Modal 科技感优化开始 --- */

        /* 1. 模态框主体：增加毛玻璃效果，去除圆角过大的笨重感 */
        .tech-modal-content {
            border: none;
            border-radius: 8px; /* 稍微锐利一点的圆角 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* 更深邃的阴影 */
            overflow: hidden; /* 保证顶部的颜色条不溢出 */
            font-family: 'Inter', sans-serif;
        }

        /* 2. 顶部彩色指示条 */
        .modal-status-bar {
            height: 4px;
            width: 100%;
        }
        .bg-gradient-success {
            background: linear-gradient(90deg, #10b981, #6ee7b7); /* 绿色渐变 */
        }
        .bg-gradient-danger {
            background: linear-gradient(90deg, #ef4444, #fca5a5); /* 红色渐变 */
        }

        /* 3. 头部样式：更简洁 */
        .tech-modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 1rem 1.5rem;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 4. 标签样式：小号、大写、淡色 */
        .tech-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }

        /* 5. 数值样式：深色、等宽字体、加粗 */
        .tech-value {
            font-size: 0.95rem;
            color: #334155;
            font-weight: 600;
            font-family: 'SF Mono', 'Roboto Mono', 'Consolas', monospace; /* 金融数字专用字体 */
        }

        /* 6. 专门针对 UID 等辅助信息的样式 */
        .tech-sub-value {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: normal;
        }

        /* 7. 关闭按钮美化 */
        .btn-close-custom {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            color: #94a3b8;
            transition: color 0.2s;
        }
        .btn-close-custom:hover {
            color: #0f172a;
        }
        /* --- Modal 科技感优化结束 --- */

        /* --- Order Form 悬浮提示条 (Mini Toast) --- */
        /* 1. 父容器必须相对定位，作为锚点 */
        .relative-container {
            position: relative;
            overflow: hidden; /* 防止圆角溢出 */
        }

        /* 2. 动画：从顶部向下滑入，透明度变化 */
        .toast-slide-enter-active,
        .toast-slide-leave-active {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* 带一点回弹效果 */
        }

        .toast-slide-enter-from,
        .toast-slide-leave-to {
            transform: translateY(-100%); /* 完全移出顶部 */
            opacity: 0;
        }

        /* 3. 提示条本体：绝对定位，覆盖在内容之上 */
        .tech-mini-toast {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 36px; /* 强制固定高度，非常紧凑 */
            z-index: 10;  /* 确保在输入框之上 */

            display: flex;
            align-items: center;
            justify-content: center;

            font-size: 0.75rem; /* 小字号 */
            font-weight: 600;
            letter-spacing: 0.03em;

            backdrop-filter: blur(8px); /* 毛玻璃效果，增加科技感 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* 成功样式：极淡的绿底 + 深绿字 */
        .toast-success {
            background-color: rgba(220, 252, 231, 0.9); /* 90% 不透明度 */
            color: #15803d;
            border-bottom: 1px solid #86efac;
        }

        /* 失败样式：极淡的红底 + 深红字 */
        .toast-error {
            background-color: rgba(254, 226, 226, 0.9);
            color: #b91c1c;
            border-bottom: 1px solid #fca5a5;
        }

        /* 3. 卡片优化：让它看起来不像原本的 Table 那么生硬 */
        .order-card {
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            border-radius: 12px; /* 圆润一点 */
            background-color: #ffffff;
        }
        .order-card-header {
            background: transparent;
            border-bottom: 1px dashed #e2e8f0; /* 虚线分割，更轻量 */
            padding: 1rem 1.2rem;
        }


        /* --- 输入框样式优化 --- */
        .order-input {
            background-color: #ffffff !important; /* 强制白底 */
            border: 1px solid #cbd5e1 !important; /* 蓝灰色细边框，比默认灰色更有质感 */
            color: #334155;
            transition: all 0.2s ease-in-out;
        }

        /* 聚焦时的效果：边框变色 + 淡淡的光晕 */
        .order-input:focus {
            background-color: #ffffff;
            border-color: #10b981 !important; /* 聚焦变成翡翠绿 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15) !important; /* 绿色柔光 */
            outline: none;
        }

        /* 调整 Placeholder/Label 的颜色，让它更柔和 */
        .form-floating > label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* 输入数值时的字体加粗一点，强调金额 */
        .order-input {
            font-weight: 600;
        }
        /**
           * End definition of Order Form
        */

    </style>

    <title>Test</title>

</head>
<body class="d-flex flex-column min-vh-100">

<!--导航栏 -->
<nav class="navbar navbar-expand-md  bg-light navbar-light sticky-top border-bottom navbar-48">
    <p class="navbar-brand d-flex align-items-center mb-0">
        <i class="bi bi-lightning"></i>Trading!<i class="bi bi-lightning"></i>
    </p>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#willCollapse">
        <span class="navbar-toggler-icon"></span>zhedie
    </button>
    <div class="collapse navbar-collapse" id="willCollapse">
        <ul class="navbar-nav mx-auto">
            <li class="nav-item">
                <a class="nav-link active" href="#">APPL</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">NVDA</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="dropdownNav"  data-bs-toggle="dropdown"  href="#" >
                    Others
                </a>
                <div class="dropdown-menu" >
                    <a class="dropdown-item" href="#">Python 1</a>
                    <a class="dropdown-item" href="#">Python 2</a>
                    <a class="dropdown-item" href="#">Python 3</a>
                </div>
            </li>
        </ul>
        <div class="navbar-nav">
            <a class="nav-link" href="cs.html" target="_blank">Simulator</a>
        </div>
        <form class="">
            <div class="input-group mx-2">
                <input class="form-control" id="nav-search" type="text" placeholder="Search...">
                <button class="btn btn-success" type="submit">Search</button>
            </div>
        </form>
        <span class="navbar-text ms-3 me-5">
            <i class="bi bi-person-circle fs-3"></i>
        </span>
    </div>
</nav>

<div id="app-frame" class="container-fluid mt-1">
    <div class="row custom-main-board">
        <div class="col-3 bg-light">
            <div>
                <table class="table table-borderless table-hover table-light table-head-lgihter table-striped table-borderless">
                    <thead>
                    <tr>
                        <th>Type</th>
                        <th>Available</th>
                        <th>Frozen</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr is="vue:asset-table" :items="assetItems"></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <!-- Order Form 模块：使用 Card 组件 -->
                <div class="card order-card mt-3">
                    <div class="card-header order-card-header">
                        <h6 class="text-uppercase text-secondary fw-bold mb-0" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                            <i class="bi bi-ui-checks-grid me-2"></i>Order Form
                        </h6>
                    </div>

                    <!-- [修改点 1] 添加 relative-container 类 -->
                    <div class="card-body p-3 relative-container">

                        <!-- [修改点 2] 悬浮提示条 (Absolute Position) -->
                        <transition name="toast-slide">
                            <div v-if="orderTip.show"
                                 :class="['tech-mini-toast', orderTip.type === 'success' ? 'toast-success' : 'toast-error']">

                                <!-- 极简图标 -->
                                <i :class="['bi me-2', orderTip.type === 'success' ? 'bi-check2-circle' : 'bi-exclamation-octagon']"
                                   style="font-size: 1rem;"></i>

                                <!-- 极简文本 -->
                                <span>{{ orderTip.msg }}</span>
                            </div>
                        </transition>

                        <!-- 表单本体 (位置完全不会变动) -->
                        <form  autocomplete="off" @submit.prevent="orderSubmit($event)">

                            <div class="form-floating mb-2">
                                <input class="form-control order-input bg-light border-0" id="price" type="number" min="0" step="0.01"
                                       name="price" placeholder="Price.." v-model="orderForm.price" required>
                                <label for="price" class="text-secondary">Price</label>
                            </div>

                            <div class="form-floating mb-3">
                                <input class="form-control order-input bg-light border-0" id="amount" type="number" min="0"
                                       name="amount" placeholder="Amount.." v-model="orderForm.amount" required>
                                <label for="amount" class="text-secondary">Amount</label>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-fill shadow-sm py-2"
                                        @click="orderForm.action='BUY'">
                                    <i class="bi bi-graph-up-arrow me-1"></i> BUY
                                </button>

                                <button type="submit" class="btn btn-danger flex-fill shadow-sm py-2"
                                        @click="orderForm.action='SELL'">
                                    <i class="bi bi-graph-down-arrow me-1"></i> SELL
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 bg-light">
            <div class="card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">交易分时图 (APPL)</h5>
                    <span class="badge bg-success" id="liveStatus">实时更新中</span>
                </div>
                <div class="card-body d-flex align-items-stretch">
                    <div id="stockChart" style="width: 100%; height: 100%"></div>
                </div>
            </div>
        </div>

        <div class="col-3 bg-light table-container">
            <table class="table  table-hover table-light table-head-lgihter">
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Amount</th>
                </tr>
                </thead>
                <tbody>
                    <template v-for="(item, index) in quotationItems" :key="index">
                        <tr v-if="item.tradeType === 'SELL'" class="table-success">
                            <td>SELL</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.volume }}</td>
                        </tr>
                        <tr v-else class="table-danger">
                            <td>BUY</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.volume }}</td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-9">
            <div class="card">
                <div class="card-body px-0 py-0 table-container">
                    <p class="card-title text-center fw-bold">MY Orders</p>
                    <table class="table table-hover table table-head-lgihter">
                        <thead>
                        <tr class="">
                            <th>Order ID</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Amount</th>
                            <th>Finished</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- [修改点 5] 绑定点击事件，调用获取详情的方法 -->
                        <tr v-for="(item, index) in avtiveOrderItems" :key="item.orderId"
                            :class="[item.type ==='SELL' ? 'table-success' : 'table-danger',{'row-animate-flash':item.isNew}]"
                            @click="fetchOrderDetails(item.orderId)">
                            <td>{{ item.orderId }}</td>
                            <td>{{ item.type }}</td>
                            <td class="text-start">{{ item.price }}</td>
                            <td class="text-start">{{ item.amount }}</td>
                            <td>{{ item.finished }}</td>
                            <td>{{ item.status }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-3">
            <div class="card table-container">
                <div class="card-body px-0 py-0">
                    <p class="card-title text-center fw-bold">Finished Orders</p>
                    <table class="table  table-light table-hover table-head-lgihter">
                        <thead>
                        <tr class="">
                            <th>Type</th>
                            <th>Price</th>
                            <th>Amount</th>
                            <th>Time</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in tradeDetails" :key="item.id"
                            :class="[item.type === 'SELL' ?'table-success':'table-danger']">
                            <td>{{ item.type }}</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.amount }}</td>
                            <td>{{ item.time }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- [修改点 1] 订单详情浮框 Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content tech-modal-content">

                <!-- 1. 顶部状态指示条 (根据买卖/状态变色) -->
                <div :class="['modal-status-bar',
                (selectedOrderDetails.status === 'FAILED') ? 'bg-gradient-danger' : 'bg-gradient-success']">
                </div>

                <!-- 2. 头部 -->
                <div class="tech-modal-header">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 fw-bold me-2">Order #{{ selectedOrderDetails.id }}</h5>
                        <!-- 状态标签 (Pill 样式) -->
                        <span :class="['badge rounded-pill',
                        selectedOrderDetails.status === 'FAILED' ? 'bg-danger' :
                        selectedOrderDetails.status === 'FINISHED' ? 'bg-success' : 'bg-secondary']"
                              style="font-size: 0.7rem; padding: 0.35em 0.8em;">
                        {{ selectedOrderDetails.status }}
                    </span>
                    </div>
                    <!-- 自定义关闭按钮 -->
                    <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- 3. 内容区域 (使用 Grid System 做两列布局) -->
                <div class="modal-body p-4">
                    <div v-if="selectedOrderDetails.id">

                        <!-- 第一行：类型 和 价格 -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="tech-label">Side / UID</div>
                                <div :class="['tech-value', selectedOrderDetails.tradeType === 'SELL' ? 'text-danger' : 'text-success']">
                                    {{ selectedOrderDetails.tradeType }}
                                    <span class="tech-sub-value ms-1">({{ selectedOrderDetails.uid }})</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tech-label">Price</div>
                                <div class="tech-value">{{ selectedOrderDetails.price }}</div>
                            </div>
                        </div>

                        <!-- 第二行：总数量 和 进度 -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="tech-label">Amount</div>
                                <div class="tech-value">{{ selectedOrderDetails.amount }}</div>
                            </div>
                            <div class="col-6">
                                <div class="tech-label">Filled / Processing</div>
                                <div class="tech-value">
                                    {{ selectedOrderDetails.finishedAmount }}
                                    <span class="tech-sub-value">/ {{ selectedOrderDetails.processingAmount }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- 第三行：时间 (占据整行) -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="tech-label">Created At</div>
                                <div class="tech-value" style="font-size: 0.85rem">{{ formattedCreatedAt }}</div>
                            </div>
                            <div class="col-6">
                                <div class="tech-label">Updated At</div>
                                <div class="tech-value" style="font-size: 0.85rem">{{ formattedUpdatedAt }}</div>
                            </div>
                        </div>

                        <!-- 失败信息区域 (仅在失败时显示) -->
                        <div v-if="(selectedOrderDetails.status.includes('ERROR') ||selectedOrderDetails.status ==='FAILED') && selectedOrderDetails.messge" class="mt-4">
                            <div class="p-3 bg-danger bg-opacity-10 rounded border border-danger border-opacity-25">
                                <div class="tech-label text-danger mb-1">Error Message</div>
                                <small class="text-danger font-monospace" style="font-size: 0.8rem;">
                                    {{ selectedOrderDetails.messge }}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Loading 状态 -->
                    <div v-else class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
                        <span style="font-size: 0.9rem">Loading Data...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Making footer come to the End of screen:
    1) Using div.flex-grow-1, eating all remaining space;
    or 2) using footer.mt-auto let it start as bottom as possible
-->
<!--<div class="flex-grow-1"></div>-->
<footer class="border-top text-center py-3 mt-auto text-muted">
    <p class="text-muted text-center mb-0">
        Copyright @zyl 2025;<br>
        Powered by: springcloud,vue.js,bootstrap
    </p>
</footer>

<script>
    const { createApp, ref, shallowRef, onMounted, onUnmounted } = Vue;
    const BASE_URL = 'http://localhost:8080/';
    const USER_ID_PW = '10:pw'
    const HTTP_CONFIG = {
        params:{},
        headers:{
            "Authorization":"Basic " + USER_ID_PW,
            'accept': 'application/json'
        },
        baseURL:BASE_URL
    }
    let IS_DEBUG = true; //wether print from console.log() or not
    if(!IS_DEBUG){
        console.log = function() {};
    }

    let timer= null
    let stopPolling = false // false
    let pollingInterval = 3000
    let dataInited = false  // run at least once! for data init case

    let errorCnt = 0;

    // [新增变量] 用于存储 Modal 实例和选中的订单详情
    let orderDetailModalInstance = null;


    const appData = {
        data(){
            return {
                /*
                assetItems:[
                    {assetType:"APPL", available:'3.5', frozen:'1.5'},
                    {assetType:"USD", available:'10', frozen:'3'}
                ],*/
                assetItems:[],
                /*
                quotationItems: [
                    {tradeType:"SELL", price: '8', volume: '4'},
                    {tradeType:"SELL", price: '9', volume: '3'}
                ],*/
                quotationItems:[],
                /*
                avtiveOrderItems: [
                    {orderId:'3568', type: 'SELL', price:'3.456', amount:'4', finished:'0', status:'0'},
                    {orderId:'3568', type: 'BUY', price:'6.78', amount:'8', finished:'0', status:'0'}
                ],
                */
                avtiveOrderItems:[],
                tradeDetails: [
                    {type:"SELL", price:"4.53", amount:"4.5", time:"12:30:32"},
                    {type:"BUY", price:"5.53", amount:"5.5", time:"12:31:32"},
                ],
                orderForm:{},
                // [修改点 2] 新增状态变量
                selectedOrderDetails: {},

                // submit orders
                orderTip: { show: false, type: 'success', msg: '' },
                orderTipTimer: null,
            }},
        methods: {
            async startPollingData(){
                if(stopPolling && dataInited) return;
                dataInited = true;
                try {
                    await Promise.all([
                        this.fetchAssetItems(),
                        this.fetchQuatationItems(),
                        this.fetchOrderList(),
                        this.fetchFinishedDetails(),
                        this.isServerAlive()
                    ]);
                    console.log("Fetch data(s) and await over.")
                }catch(err){
                    console.error("Fetch data(s) error!", err)
                }
                timer = setTimeout(this.startPollingData, pollingInterval);
            },
            async fetchAssetItems(){
                // get asset
                await axios.get('/api/asset/list', {
                    params:{},
                    headers:{
                        "Authorization":"Basic " + USER_ID_PW,
                        'accept': 'application/json'
                    },
                    baseURL:BASE_URL
                })
                    .then(response => {
                        console.log("fetched asset, raw data=", response.data);
                        let rawData = response.data.data || [];
                        if(!rawData.some(item => item.assetType === 'APPL')){
                            rawData.push({assetType:"APPL", available:'0', frozen:'0'})
                        }
                        if(!rawData.some(item => item.assetType === 'USD')){
                            rawData.push({ assetType:"USD", available:'0', frozen:'0'})
                        }
                        this.assetItems = rawData;
                        console.log("processed assetItems = ", this.assetItems);
                    })
                    .catch(error => {
                        console.error('Fetch asset items fail!', error);
                    })
            },
            async fetchQuatationItems(){
                console.log("Begin to fetch quatationItems..");
                await axios.get('/api/trade/quotation', HTTP_CONFIG)
                    .then(response => {
                        console.log("fetched trade quotation", response.data);
                        const rawData = response.data.data || {};
                        const rSellList =rawData.SELL || []
                        const rBuyList =rawData.BUY || []

                        if(rSellList.length === 0) rSellList.push({ price: '-', volume: '-',tradeType:'SELL',})
                        let sellList = rSellList.sort((a,b) => b.price - a.price).slice(0,5);

                        if (rBuyList.length === 0) rBuyList.push({price: '-', volume: '-', tradeType:'BUY',})
                        let buyList = rBuyList.sort((a,b) => b.price - a.price).slice(0,5);

                        let list = sellList.concat(buyList);
                        //console.log('list=', list);
                        this.quotationItems = list;
                    })
                    .catch(error => {
                        console.error("fetch quatation items fail!", error);
                    })
            },
            async fetchOrderList(){
                await axios.get('/api/order/list', HTTP_CONFIG)
                    .then(response => {
                        const rawData = response.data.data || [];
                        console.log("fetched order list over, data=", rawData.slice(-2));
                        let mappedOrderItems = rawData.map(item => {
                            let newRcd = true;
                            if(this.avtiveOrderItems.some(
                                i => i.orderId === item.id && i.updatedAt === item.updatedAt)) {
                                newRcd = false;
                                //console.log("fetched order items, Fetched some old items!");
                            }
                            return {
                                orderId: item.id,
                                price: item.price,
                                type: item.tradeType,
                                amount: item.amount,
                                finished: item.finishedAmount,
                                status: item.status,
                                updatedAt: item.updatedAt,
                                isNew:newRcd
                            };
                        });
                        let sortedMappedOrderItems = mappedOrderItems.sort((a,b) => {
                            let at = new Date(a.updatedAt)
                            let bt = new Date(b.updatedAt)
                            return bt.getTime() - at.getTime();
                        });
                        console.log("mapppedOrders=", sortedMappedOrderItems.slice(0,2));
                        this.avtiveOrderItems = sortedMappedOrderItems.slice(0,15);
                        setTimeout(() => {
                            this.avtiveOrderItems?.forEach((item) => item.isNew = false);
                        },1500)
                    })
                    .catch(error => {
                        console.error("fetch order lists fail!", error);
                    })
            },
            // [修改点 4] 新增获取订单详情的方法
            async fetchOrderDetails(orderId){
                console.log(`fetching details for order ID: ${orderId}`);

                // 1. 重置数据并显示浮框（显示 Loading 状态）
                this.selectedOrderDetails = {};
                if (orderDetailModalInstance) {
                    orderDetailModalInstance.show();
                }

                // 2. 调用后端 API
                await axios.get(`/api/order/get`, {
                    ...HTTP_CONFIG,
                    params: {
                        order_id: orderId
                    }
                })
                    .then(response => {
                        const res = response.data; // 获取完整的响应体

                        // [逻辑修改] 先判断外层的 success 是否为 true
                        if (res.success && res.data) {
                            // 请求成功，且有数据，填充到 selectedOrderDetails
                            this.selectedOrderDetails = res.data;
                            console.log("fetched details success:", this.selectedOrderDetails);
                        } else {
                            // API 请求虽通，但在业务上失败了（比如 success: false，或者 data 为空）
                            console.warn("fetch details logical fail:", res);
                            this.selectedOrderDetails = {
                                id: orderId,
                                status: 'ERROR:' + res.status,
                                // 优先使用外层的 message，如果没有则显示默认错误
                                messge: res.message || '获取订单详情失败 (Data not found)'
                            };
                        }
                    })
                    .catch(error => {
                        console.error("fetch order details network fail!", error);
                        this.selectedOrderDetails = {
                            id: orderId,
                            status: 'NETWORK_ERROR',
                            messge: `网络请求失败: ${error.message}`
                        };
                    })
            },
            async orderSubmit(event){
                // 1. 重置提示
                if(this.orderTipTimer) clearTimeout(this.orderTipTimer);
                this.orderTip.show = false;

                // 2. 准备请求
                let actionType = this.orderForm.action;
                let url = (actionType === 'SELL') ? '/api/trade/sell' : '/api/trade/buy';

                // 3. 发送请求
                await axios.get(url, {
                    ...HTTP_CONFIG,
                    params: {
                        price: this.orderForm.price,
                        amount: this.orderForm.amount
                    }
                })
                    .then(response => {
                        const res = response.data;
                        console.log("order submitted.", res);

                        // 4. 显示成功提示 (Green)
                        // 假设后端返回 code 200 或 success: true，这里简化处理
                        if(res.success){
                            this.showOrderTip('success', `${actionType} Order has been queued.`);
                        }else{
                            this.showOrderTip('error', `${actionType} Order failed. ${res.data.message}`);

                        }
                    })
                    .catch(error => {
                        console.error("order submitt fail!", error);
                        // 5. 显示失败提示 (Red)
                        this.showOrderTip('error', 'Network or Server Error.');
                    });

                this.orderForm = {}; // 清空表单
            },

// 辅助方法
            showOrderTip(type, msg) {
                // 延迟一点点以允许 Vue 重新渲染动画
                setTimeout(() => {
                    this.orderTip = { show: true, type, msg };
                }, 100);

                // 3秒后自动隐藏
                this.orderTipTimer = setTimeout(() => {
                    this.orderTip.show = false;
                }, 3000);
            },
            async fetchFinishedDetails(){
                await axios.get('api/trade/finishedDetails', HTTP_CONFIG)
                    .then(response => {
                        console.log("fetched finished details:", response.data.data);
                        const rawData = response.data.data || [];
                        let fmtedData = rawData.map(item => {
                            let localTime = new Date(item.updatedAt);
                            return {
                                id: item.id + localTime.getTime(),
                                type: item.tradeType,
                                price: item.price,
                                amount: item.amount,
                                time: localTime.toLocaleTimeString() // HH:mm:ss
                            }
                        })
                        let sortedFmtedData = fmtedData.sort((a,b) => b.time.localeCompare(a.time));
                        this.tradeDetails = sortedFmtedData;
                    })
                    .catch(error => {
                        console.error("fetch finished details fail!", error);
                    })
            },
            async isServerAlive(){
                await axios.get('/api/hello', HTTP_CONFIG)
                    .then(response => {
                        errorCnt = 0;
                    })
                    .catch(error => {
                        if(++errorCnt >= 20){
                            stopPolling = true;
                            console.error("Server response error for a long time, stop polling data.");
                        }
                    })
            }
        },
        computed:{
            formattedCreatedAt() {
                if (this.selectedOrderDetails.createdAt) {
                    return new Date(this.selectedOrderDetails.createdAt).toLocaleString();
                }
                return '-';
            },
            formattedUpdatedAt() {
                if (this.selectedOrderDetails.updatedAt) {
                    return new Date(this.selectedOrderDetails.updatedAt).toLocaleString();
                }
                return '-';
            }
        },
        components:{},
        created(){
            console.log("app created.");
        },
        mounted(){
            console.log("root mounted over.")

            // [修改点 3] 初始化 Bootstrap Modal JS 实例
            const modalEl = document.getElementById('orderDetailModal');
            if (modalEl) {
                orderDetailModalInstance = new bootstrap.Modal(modalEl);
            }

            this.startPollingData();
        },
        beforeUnmount() {
            stopPolling = true
        },
        setup(){
            const chartInst = shallowRef(null);
            const chartData = {}
            let tickTimer = null

            const initChart = () => {
                const chartDom = document.getElementById('stockChart');
                chartInst.value = echarts.init(chartDom);
                const now = Date.now();
                const start = now - 1 * 60 * 1000
                const future = now + 30 * 60 * 1000;//10分钟
                const options = {
                    grid: { // 调整图表的边距，否则图标会被挤在中间
                        top: '10%', bottom: '10%', left: '5%', right: '5%',
                        containLabel: true // 核心：设为 true，ECharts 会自动调整间距以确保坐标轴文字不被切掉
                    },
                    xAxis: {
                        type: 'time',
                        min: start,
                        max: future,
                        boundaryGap: false,
                        //data:[],
                        axisLabels: {
                            formatter: (value) => {
                                const date = new Date(value);
                                const hour = date.getHours();
                                const minute = date.getMinutes().toString().padStart(2, "0");
                                const second = date.getSeconds().toString().padStart(2, "0");
                                return `${hour}:${minute}:${second}`;
                            },
                            hideOverlap: true,
                        },
                        axisTick:{ show: false }, // 隐藏 X 轴刻度短线
                        axisLine: {lineStyle: { color: '#eee' } } // 让轴线颜色淡一点
                    },
                    yAxis: {
                        type: 'value',
                        scale: false,
                        axisTick: {show: false},
                        splitLine: {lineStyle: { type: 'dashed' }}, // 背景线设为虚线，更有高级感
                        axisLabel: {
                            margin: 8, // 文字距离轴线的距离
                            fontSize: 10,
                            color: '#999'
                        }
                    },
                    // 开启提示框
                    tooltip: {
                        trigger: 'axis',          // 坐标轴触发，这样鼠标悬停在曲线上任何位置都能显示
                        axisPointer: {            // 配置指示器
                            type: 'cross',        // 指示器类型：'line' 是直线，'cross' 是十字准星（含横纵两条虚线）
                            label: {
                                backgroundColor: '#6a7985' // 坐标轴标签的背景色
                            }
                        }
                    },
                    // 配置 dataZoom (slide 模式)
                    dataZoom: [
                        {
                            type: 'slider',       // 使用滑动条模式
                            start: 0,
                            end: 100
                        }
                    ],
                    axisPointer: {
                        type: 'line',
                        lineStyle: {
                            color: '#ef4444',    // 虚线颜色
                            width: 1,            // 虚线宽度
                            type: 'dashed'       // 明确指定为虚线
                        }
                    },
                    series: [{
                        type: 'line',
                        smooth: true,
                        symbol:'none',
                        data: [],
                        showSymbol: false, // 只有鼠标悬停才显示圆点

                        lineStyle: {
                            width: 2,
                            color: '#ef4444', // 2) 股市常用的红色 (Coral Red)
                            shadowColor: 'rgba(59, 130, 246, 0.3)',
                            shadowBlur: 10
                        },
                        areaStyle: {
                            // 给曲线下方加一点极淡的红色渐变，更有质感
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.2)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0)' }
                            ]),
                            lineStyle: {color: '#3a84ff', width: 2}
                        }
                    }]
                }
                chartInst.value.setOption(options);
            };

            const fetchRealTimeTicks = async () => {
                if(stopPolling) {
                    clearInterval(tickTimer); // 销毁组件时清除定时器
                    return
                }
                await axios.get('/api/trade/realtime-ticks', {
                    ...HTTP_CONFIG,
                    params: {num_items: 20}
                })
                    .then(response => {
                        const rawData = response.data.data || [];
                        console.log("fetched ticks...", rawData.length, " items");
                        if(rawData.length === 0)
                            return;
                        rawData.forEach(item => {
                            const {time, price} = item;
                            const curTimestamp = Math.floor(new Date(time).getTime()/1000) * 1000; //时间戳,精度到秒
                            chartData[curTimestamp] = price // 有，就直接覆盖，没有，就直接添加
                        })
                        let sortedTimes = Object.keys(chartData).sort();
                        if(sortedTimes.length > 3600){ //最多保留3600个元素,删除最早的
                            delete chartData[sortedTimes[0]]
                            sortedTimes.shift()
                        }
                        let sortedTuple = sortedTimes.map((k) => {
                            return[
                                Number(k), // 关键：手动转回数字，确保 ECharts time轴识别准确, 否则传过去的是字符串型！
                                chartData[k]
                            ]
                        })
                        console.log("sortedTimes:", sortedTimes.slice(-2))
                        console.log("sortedTuple:", sortedTuple.length, sortedTuple.slice(-2))
                        chartInst.value.setOption({
                            //xAxis: {data: sortedTimes},
                            series: [
                                {data: sortedTuple}
                            ]
                        })
                    })
                    .catch(error => {
                        console.error("fetch ticks fail!", error);
                    })
            };

            onMounted(() => {
                initChart();
                fetchRealTimeTicks(); // 立即执行一次
                if(!stopPolling)
                    tickTimer = setInterval(fetchRealTimeTicks, pollingInterval); // 每3秒轮询一次

                // 响应式缩放
                window.addEventListener('resize', () => chartInst.value?.resize());
            });

            onUnmounted(() => {
                clearInterval(tickTimer); // 销毁组件时清除定时器
            });

            return {};//没有需要直接暴露给HTML模板的变量
        }
    }
    const app = Vue.createApp(appData)
    app.component('asset-table',{
        template: `
                <tr v-for="(item, index) in items" :key="index">
                  <td>{{ item.assetType }}</td>
                  <td>{{ item.available }}</td>
                  <td>{{ item.frozen }}</td>
                </tr>
        `,
        props: ['items'],
        data(){
            return {}
        },
        computed:{},
        methods:{},
        mounted(){}
    })
    app.mount('#app-frame')
</script>
</body>
</html>